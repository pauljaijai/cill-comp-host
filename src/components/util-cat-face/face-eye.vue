<template>
  <svg
    :id
    ref="svgRef"
    class="h-full w-full"
    :viewBox
    fill="none"
    xmlns="http://www.w3.org/2000/svg"
  >
    <g id="face-eye">
      <path
        id="eye-r"
        d="M166 508C166 445.94 215.945 418 256 418C296.055 418 346 448.165 346 508C346 567.835 316.082 598 256 598C195.918 598 166 563.879 166 513.192"
        stroke="black"
        stroke-width="200"
        stroke-linecap="round"
      />
      <path
        id="eye-l"
        d="M1346 508C1346 445.94 1296.05 418 1256 418C1215.95 418 1166 448.165 1166 508C1166 567.835 1195.92 598 1256 598C1316.08 598 1346 563.879 1346 513.192"
        stroke="black"
        stroke-width="200"
        stroke-linecap="round"
      />
    </g>

    <defs class="hidden">
      <g class="neutral">
        <path
          id="eye-r"
          d="M166 508C166 445.94 215.945 418 256 418C296.055 418 346 448.165 346 508C346 567.835 316.082 598 256 598C195.918 598 166 563.879 166 513.192"
          stroke="black"
          stroke-width="200"
          stroke-linecap="round"
        />
        <path
          id="eye-l"
          d="M1346 508C1346 445.94 1296.05 418 1256 418C1215.95 418 1166 448.165 1166 508C1166 567.835 1195.92 598 1256 598C1316.08 598 1346 563.879 1346 513.192"
          stroke="black"
          stroke-width="200"
          stroke-linecap="round"
        />
      </g>
      <g class="neutral">
        <path
          id="eye-r"
          d="M166 508C166 506.621 215.945 506 256 506C296.055 506 346 506.67 346 508C346 509.33 316.082 510 256 510C195.918 510 166 509.242 166 508.115"
          stroke="black"
          stroke-width="100"
          stroke-linecap="round"
        />
        <path
          id="eye-l"
          d="M1346 508C1346 506.621 1296.05 506 1256 506C1215.95 506 1166 506.67 1166 508C1166 509.33 1195.92 510 1256 510C1316.08 510 1346 509.242 1346 508.115"
          stroke="black"
          stroke-width="100"
          stroke-linecap="round"
        />
      </g>

      <g class="excited">
        <path
          id="eye-r"
          d="M210 386C249 404.916 301.5 435.082 306 438.765C310.5 442.449 372 484.562 372 497.173C372 509.783 325 545.237 315.5 552.593C306 559.949 249 592.084 210 611"
          stroke="black"
          stroke-width="100"
          stroke-linecap="round"
        />
        <path
          id="eye-l"
          d="M1290 382C1251 400.916 1198.5 431.082 1194 434.765C1189.5 438.449 1128 480.562 1128 493.173C1128 505.783 1175 541.237 1184.5 548.593C1194 555.949 1251 588.084 1290 607"
          stroke="black"
          stroke-width="100"
          stroke-linecap="round"
        />
      </g>
      <g class="excited">
        <path
          id="eye-r"
          d="M210 401C249 417.31 301.5 443.319 306 446.496C310.5 449.672 372 485.982 372 496.855C372 507.729 325 538.297 315.5 544.64C306 550.983 249 578.69 210 595"
          stroke="black"
          stroke-width="100"
          stroke-linecap="round"
        />
        <path
          id="eye-l"
          d="M1290 398C1251 414.31 1198.5 440.319 1194 443.496C1189.5 446.672 1128 482.982 1128 493.855C1128 504.729 1175 535.297 1184.5 541.64C1194 547.983 1251 575.69 1290 592"
          stroke="black"
          stroke-width="100"
          stroke-linecap="round"
        />
      </g>

      <g class="happy">
        <path
          id="eye-r"
          d="M152 499.74C162.347 474.172 199.536 423.244 210.325 415.5C221.114 407.756 276.302 356.431 311.709 362.407C347.116 368.384 383.16 442.239 390.362 453.089C397.565 463.94 419.667 516.232 420.66 545.09"
          stroke="black"
          stroke-width="100"
          stroke-linecap="round"
        />
        <path
          id="eye-l"
          d="M1357.83 497.74C1347.48 472.172 1310.29 421.244 1299.5 413.5C1288.71 405.756 1233.52 354.431 1198.12 360.407C1162.71 366.384 1126.67 440.239 1119.46 451.089C1112.26 461.94 1090.16 514.232 1089.17 543.09"
          stroke="black"
          stroke-width="100"
          stroke-linecap="round"
        />
      </g>
      <g class="happy">
        <path
          id="eye-r"
          d="M155.381 482.808C164.301 456.708 198.624 403.806 208.969 395.478C219.315 387.151 271.587 332.859 307.27 336.873C342.953 340.887 383.016 412.641 390.806 423.077C398.596 433.514 423.55 484.507 426.134 513.266"
          stroke="black"
          stroke-width="100"
          stroke-linecap="round"
        />
        <path
          id="eye-l"
          d="M1349.4 490.989C1342.37 464.317 1311.93 409.092 1302.2 400.044C1292.48 390.997 1244.23 333.099 1208.36 334.546C1172.48 335.993 1127.37 404.692 1118.86 414.544C1110.34 424.395 1081.8 473.469 1077.16 501.969"
          stroke="black"
          stroke-width="100"
          stroke-linecap="round"
        />
      </g>

      <g class="sad">
        <path
          id="eye-r"
          d="M166 508C166 475.5 177 494.662 256 460.5C335 426.338 346 448.165 346 508C346 567.835 316.082 598 256 598C195.918 598 166 563.879 166 513.192"
          stroke="black"
          stroke-width="180"
          stroke-linecap="round"
        />
        <path
          id="eye-l"
          d="M1346 520.535C1346 492.799 1294.5 480.78 1240.5 453.043C1186.5 425.307 1166 465.215 1166 520.535C1166 575.856 1195.92 603.744 1256 603.744C1316.08 603.744 1326 603.037 1354.5 652.5"
          stroke="black"
          stroke-width="180"
          stroke-linecap="round"
        />
      </g>
      <g class="sad">
        <path
          id="eye-r"
          d="M166 508C166 475.5 177 495.162 256 461C335 426.838 346 448.165 346 508C346 567.835 316.082 598 256 598C195.918 598 166 563.879 166 513.192"
          stroke="black"
          stroke-width="180"
          stroke-linecap="round"
        />
        <path
          id="eye-l"
          d="M1346 520.535C1346 494 1298.5 482.236 1244.5 454.5C1190.5 426.764 1166 465.215 1166 520.535C1166 575.855 1195.92 603.744 1256 603.744C1316.08 603.744 1346 638 1359.5 687.5"
          stroke="black"
          stroke-width="180"
          stroke-linecap="round"
        />
      </g>

      <g class="angry">
        <path
          id="eye-r"
          d="M166 508C166 445.94 202.445 431 242.5 431C246.5 431 346 501 346 508C346 567.835 316.082 598 256 598C195.918 598 166 563.879 166 513.192"
          stroke="black"
          stroke-width="200"
          stroke-linecap="round"
        />
        <path
          id="eye-l"
          d="M1346 508C1346 445.939 1317.55 433 1277.5 433C1271.5 433 1166 501.5 1166 508C1166 567.835 1195.92 598 1256 598C1316.08 598 1346 563.879 1346 513.192"
          stroke="black"
          stroke-width="200"
          stroke-linecap="round"
        />
      </g>

      <g class="surprised">
        <path
          id="eye-r"
          d="M128 508C128 422.495 199.033 384 256 384C312.967 384 384 425.56 384 508C384 590.44 341.451 632 256 632C170.549 632 128 584.989 128 515.154"
          stroke="black"
          stroke-width="50"
          stroke-linecap="round"
        />
        <path
          id="eye-l"
          d="M1401 508C1401 422.495 1326.64 384 1267 384C1207.36 384 1133 425.56 1133 508C1133 590.44 1177.54 632 1267 632C1356.46 632 1401 584.989 1401 515.154"
          stroke="black"
          stroke-width="50"
          stroke-linecap="round"
        />
      </g>
      <g class="surprised">
        <path
          id="eye-r"
          d="M117 508C117 411.462 194.137 368 256 368C317.863 368 395 414.923 395 508C395 601.077 348.794 648 256 648C163.206 648 117 594.923 117 516.077"
          stroke="black"
          stroke-width="50"
          stroke-linecap="round"
        />
        <path
          id="eye-l"
          d="M1406 508C1406 416.288 1328.86 375 1267 375C1205.14 375 1128 419.577 1128 508C1128 596.423 1174.21 641 1267 641C1359.79 641 1406 590.577 1406 515.673"
          stroke="black"
          stroke-width="50"
          stroke-linecap="round"
        />
      </g>

      <g class="derpy">
        <path
          id="eye-r"
          d="M196 375C196 312.94 245.945 285 286 285C326.055 285 376 315.165 376 375C376 434.835 346.082 465 286 465C225.918 465 196 430.879 196 380.192"
          stroke="black"
          stroke-width="50"
          stroke-linecap="round"
        />
        <path
          id="eye-l"
          d="M1336 590C1336 527.94 1286.05 500 1246 500C1205.95 500 1156 530.165 1156 590C1156 649.835 1185.92 680 1246 680C1306.08 680 1336 645.879 1336 595.192"
          stroke="black"
          stroke-width="50"
          stroke-linecap="round"
        />
      </g>

      <g class="speechless">
        <path
          id="eye-r"
          d="M166 498C166 500.069 215.945 501 256 501C296.055 501 346 499.995 346 498C346 496.005 316.082 495 256 495C195.918 495 166 496.137 166 497.827"
          stroke="black"
          stroke-width="100"
          stroke-linecap="round"
        />
        <path
          id="eye-l"
          d="M1370 514C1370 516.069 1320.05 517 1280 517C1239.95 517 1190 515.995 1190 514C1190 512.005 1219.92 511 1280 511C1340.08 511 1370 512.137 1370 513.827"
          stroke="black"
          stroke-width="100"
          stroke-linecap="round"
        />
      </g>

      <g class="pleasant">
        <path
          id="eye-r"
          d="M167.791 499.18C169.026 500.84 198.959 479.73 222.52 462.2C246.08 444.671 274.858 422.007 273.667 420.407C272.477 418.807 254.279 431.093 218.938 457.387C183.598 483.68 166.679 497.686 167.687 499.041"
          stroke="black"
          stroke-width="100"
          stroke-linecap="round"
        />
        <path
          id="eye-l"
          d="M1361.59 521.126C1358.54 523.971 1332.8 499.184 1313.26 478.278C1293.72 457.372 1270.83 429.922 1273.76 427.179C1276.69 424.436 1292.77 438.668 1322.09 470.027C1351.4 501.386 1364.33 518.565 1361.84 520.888"
          stroke="black"
          stroke-width="100"
          stroke-linecap="round"
        />
      </g>

      <g class="confidence">
        <path id="eye-r" d="M166 508C166 445.939 202.445 431 242.5 431C328.5 416 346 501 346 508C346 567.835 316.082 598 256 598C195.918 598 166 563.879 166 513.192" stroke="black" stroke-width="200" stroke-linecap="round" />
        <path id="eye-l" d="M1346 508C1346 445.939 1317.55 433 1277.5 433C1217.5 433 1166 460.5 1166 508C1166 567.835 1195.92 598 1256 598C1316.08 598 1346 563.879 1346 513.192" stroke="black" stroke-width="200" stroke-linecap="round" />
      </g>

    </defs>
  </svg>
</template>

<script setup lang="ts">
import type { FacialExpression } from './type'
import { throttleFilter, useMounted, useMouseInElement } from '@vueuse/core'
import anime from 'animejs'
import { isNumber, map, pipe } from 'remeda'
import { computed, onMounted, reactive, ref, useId, watch } from 'vue'
import { mapNumber } from '../../common/utils'
import { getKeyframeList } from './utils'

// #region Props
interface Props {
  facialExpression: `${FacialExpression}`;
  /** 眼睛偏移半徑 */
  eyeOffsetRadius: number;
}
// #endregion Props
const props = withDefaults(defineProps<Props>(), {})

const id = useId()
const nameId = 'face-eye'
const partIdList = ['eye-r', 'eye-l'] as const

function getTargetId(partId: string) {
  return `#${id} #${nameId} #${partId}`
}

const svgRef = ref()
const mouseInfo = reactive(useMouseInElement(svgRef, {
  eventFilter: throttleFilter(15),
}))

const viewBox = computed(() => {
  const ignoredList: `${FacialExpression}`[] = [
    'excited',
    'happy',
  ]

  if (ignoredList.includes(props.facialExpression)) {
    return '0 0 1500 1000'
  }

  const offset = props.eyeOffsetRadius

  const [x, y] = pipe(
    /** 以 svg 為中心為原點之滑鼠座標 */
    {
      x: mouseInfo.elementWidth / 2 - mouseInfo.elementX,
      y: mouseInfo.elementHeight / 2 - mouseInfo.elementY,
    },
    /** 計算角度並從 eyeOffsetRadius 計算 xy 分量 */
    (position) => {
      const xRadius = Math.abs(
        mapNumber(
          position.x,
          -mouseInfo.elementWidth / 2,
          mouseInfo.elementWidth / 2,
          -offset,
          offset,
        ),
      )

      const yRadius = Math.abs(
        mapNumber(
          position.y,
          -mouseInfo.elementHeight / 2,
          mouseInfo.elementHeight / 2,
          -offset,
          offset,
        ),
      )

      const angle = Math.atan2(position.y, position.x)
      return [
        Math.cos(angle) * xRadius,
        Math.sin(angle) * yRadius,
      ]
    },
    map((value) => isNumber(value) ? value : 0),
  )

  return `${x} ${y} 1500 1000`
})

const facialExpressionProviderMap: Record<
  FacialExpression,
  () => Promise<void>
> = {
  neutral: async () => {
    const keyframeList = getKeyframeList(id, partIdList, 'neutral')

    await Promise.all(
      partIdList.map((partId) =>
        anime({
          targets: getTargetId(partId),
          ...keyframeList[0]?.[partId],
          duration: 500,
        }).finished,
      ),
    )

    await Promise.all(
      partIdList.map((partId) =>
        anime({
          targets: getTargetId(partId),
          keyframes: keyframeList.map((keyframe) => keyframe[partId]),
          duration: 50,
          delay: 3000,
          loop: true,
          direction: 'alternate',
        }).finished,
      ),
    )
  },
  excited: async () => {
    const keyframeList = getKeyframeList(id, partIdList, 'excited')

    await Promise.all(
      partIdList.map((partId) =>
        anime({
          targets: getTargetId(partId),
          ...keyframeList[0]?.[partId],
          duration: 500,
        }).finished,
      ),
    )

    await Promise.all(
      partIdList.map((partId) =>
        anime({
          targets: getTargetId(partId),
          keyframes: pipe(
            keyframeList.map((keyframe) => keyframe[partId]),
            /** 頭尾相接
             *
             * 因為使用 direction: 'alternate' 效果不自然
             */
            (list) => {
              const newList = [...list].reverse().slice(1)
              return [...list, ...newList]
            },
          ),
          duration: 1600,
          loop: true,
        }).finished,
      ),
    )
  },
  happy: async () => {
    const keyframeList = getKeyframeList(id, partIdList, 'happy')

    await Promise.all(
      partIdList.map((partId) =>
        anime({
          targets: getTargetId(partId),
          ...keyframeList[0]?.[partId],
          duration: 500,
        }).finished,
      ),
    )

    await Promise.all(
      partIdList.map((partId) =>
        anime({
          targets: getTargetId(partId),
          keyframes: pipe(
            keyframeList.map((keyframe) => keyframe[partId]),
            /** 頭尾相接
             *
             * 因為使用 direction: 'alternate' 效果不自然
             */
            (list) => {
              const newList = [...list].reverse().slice(1)
              return [...list, ...newList]
            },
          ),
          duration: 1600,
          loop: true,
        }).finished,
      ),
    )
  },
  sad: async () => {
    const keyframeList = getKeyframeList(id, partIdList, 'sad')

    await Promise.all(
      partIdList.map((partId) =>
        anime({
          targets: getTargetId(partId),
          ...keyframeList[0]?.[partId],
          duration: 500,
        }).finished,
      ),
    )

    await Promise.all(
      partIdList.map((partId) =>
        anime({
          targets: getTargetId(partId),
          keyframes: pipe(
            keyframeList.map((keyframe) => keyframe[partId]),
            /** 頭尾相接
             *
             * 因為使用 direction: 'alternate' 效果不自然
             */
            (list) => {
              const newList = [...list].reverse().slice(1)
              return [...list, ...newList]
            },
          ),
          duration: 1600,
          easing: 'easeInOutCubic',
          loop: true,
        }).finished,
      ),
    )
  },
  angry: async () => {
    const keyframeList = getKeyframeList(id, partIdList, 'angry')

    await Promise.all(
      partIdList.map((partId) =>
        anime({
          targets: getTargetId(partId),
          ...keyframeList[0]?.[partId],
          duration: 200,
          easing: 'easeInOutCirc',
        }).finished,
      ),
    )
  },
  surprised: async () => {
    const keyframeList = getKeyframeList(id, partIdList, 'surprised')

    await Promise.all(
      partIdList.map((partId) =>
        anime({
          targets: getTargetId(partId),
          ...keyframeList[0]?.[partId],
          duration: 500,
        }).finished,
      ),
    )

    await Promise.all(
      partIdList.map((partId) =>
        anime({
          targets: getTargetId(partId),
          keyframes: pipe(
            keyframeList.map((keyframe) => keyframe[partId]),
            /** 頭尾相接
             *
             * 因為使用 direction: 'alternate' 效果不自然
             */
            (list) => {
              const newList = [...list].reverse().slice(1)
              return [...list, ...newList]
            },
          ),
          duration: 1400,
          delay: 400,
          loop: true,
        }).finished,
      ),
    )
  },
  derpy: async () => {
    const keyframeList = getKeyframeList(id, partIdList, 'derpy')

    await Promise.all(
      partIdList.map((partId) =>
        anime({
          targets: getTargetId(partId),
          ...keyframeList[0]?.[partId],
          duration: 800,
        }).finished,
      ),
    )
  },
  speechless: async () => {
    const keyframeList = getKeyframeList(id, partIdList, 'speechless')

    await Promise.all(
      partIdList.map((partId) =>
        anime({
          targets: getTargetId(partId),
          ...keyframeList[0]?.[partId],
          duration: 800,
        }).finished,
      ),
    )
  },
  pleasant: async () => {
    const keyframeList = getKeyframeList(id, partIdList, 'pleasant')

    await Promise.all(
      partIdList.map((partId) =>
        anime({
          targets: getTargetId(partId),
          ...keyframeList[0]?.[partId],
          duration: 800,
        }).finished,
      ),
    )
  },
  confidence: async () => {
    const keyframeList = getKeyframeList(id, partIdList, 'confidence')

    await Promise.all(
      partIdList.map((partId) =>
        anime({
          targets: getTargetId(partId),
          ...keyframeList[0]?.[partId],
          easing: 'easeInOutCirc',
          duration: 800,
        }).finished,
      ),
    )
  },
}
function startAnimation() {
  anime.remove(partIdList.map((id) => getTargetId(id)))
  facialExpressionProviderMap[props.facialExpression]?.()
}

onMounted(() => {
  startAnimation()
})

const isMounted = useMounted()
watch(() => props.facialExpression, () => {
  if (!isMounted.value)
    return

  startAnimation()
})
</script>

<style scoped lang="sass">
</style>
