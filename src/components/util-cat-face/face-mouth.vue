<template>
  <svg
    :id
    class="h-full w-full"
    viewBox="0 0 1500 1000"
    fill="none"
    xmlns="http://www.w3.org/2000/svg"
  >
    <g id="face-mouth">
      <path
        id="palate"
        d="M630.439 663C587.274 706.267 623.48 751 666.346 751C720.972 751 745.419 669.6 748.475 669.6C751.531 669.6 774.069 751 831.75 751C882.417 751 907.767 707.733 869.568 663"
        stroke="black"
        stroke-width="50"
        stroke-linecap="round"
      />
      <path
        id="jaw"
        d="M630.439 663C587.274 706.267 623.48 751 666.346 751C720.972 751 745.419 669.6 748.475 669.6C751.531 669.6 774.069 751 831.75 751C882.417 751 907.767 707.733 869.568 663"
        stroke="black"
        stroke-width="50"
        stroke-linecap="round"
      />
    </g>

    <defs class="hidden">
      <g class="neutral">
        <path
          id="palate"
          d="M630.439 663C587.274 706.267 623.48 751 666.346 751C720.972 751 745.419 669.6 748.475 669.6C751.531 669.6 774.069 751 831.75 751C882.417 751 907.767 707.733 869.568 663"
          stroke="black"
          stroke-width="50"
          stroke-linecap="round"
        />
        <path
          id="jaw"
          d="M630.439 663C587.274 706.267 623.48 751 666.346 751C720.972 751 745.419 669.6 748.475 669.6C751.531 669.6 774.069 751 831.75 751C882.417 751 907.767 707.733 869.568 663"
          stroke="black"
          stroke-width="0"
          stroke-linecap="round"
        />
      </g>

      <g class="excited">
        <path
          id="palate"
          d="M621.439 523C578.274 566.267 614.48 611 657.346 611C711.972 611 736.419 529.6 739.475 529.6C742.531 529.6 765.069 611 822.75 611C873.417 611 898.767 567.733 860.568 523"
          stroke="black"
          stroke-width="50"
          stroke-linecap="round"
        />
        <path
          id="jaw"
          d="M625.5 607C569.5 674 633 888 671.5 924C695.563 946.5 730.5 968.5 783.5 968.5C836.5 968.5 866.501 952.5 895 924C928.034 890.966 906.001 653 859.001 607"
          stroke="black"
          stroke-width="50"
          stroke-linecap="round"
        />
      </g>

      <g class="happy">
        <path
          id="palate"
          d="M621.848 381C575.254 424.267 614.336 469 660.607 469C719.571 469 745.96 387.6 749.259 387.6C752.557 387.6 776.885 469 839.148 469C893.839 469 921.202 425.733 879.969 381"
          stroke="black"
          stroke-width="50"
          stroke-linecap="round"
        />
        <path
          id="jaw"
          d="M615.47 477C598.311 507.44 551.583 791.83 615.471 876.663C664.702 942.033 717.976 959 748.872 959C779.769 959 852.521 934.408 881.626 892.132C956.691 783.097 906.066 523.907 893.589 477"
          stroke="black"
          stroke-width="50"
          stroke-linecap="round"
        />
      </g>

      <g class="sad">
        <path
          id="jaw"
          d="M529 735C583.5 701 623.479 751 666.346 751C720.971 751 745.419 669.6 748.475 669.6C751.531 669.6 774.069 751 831.75 751C882.417 751 903.5 698.5 970 759"
          stroke="black"
          stroke-width="50"
          stroke-linecap="round"
        />
        <path
          id="palate"
          d="M529 735C583.5 701 623.479 751 666.346 751C720.971 751 745.419 669.6 748.475 669.6C751.531 669.6 774.069 751 831.75 751C882.417 751 903.5 698.5 970 759"
          stroke="black"
          stroke-width="50"
          stroke-linecap="round"
        />
      </g>

      <g class="angry">
        <path
          id="palate"
          d="M569.25 599.543C577.102 636.695 590.737 676.357 634.957 666.818C679.177 657.279 759.474 537.5 762 537.5C764.526 537.5 849.44 666.818 878.368 675.353C919.062 687.361 937.465 631.172 943.25 589"
          stroke="black"
          stroke-width="50"
          stroke-linecap="round"
        />
        <path
          id="jaw"
          d="M614 683.984C614 726.385 636.886 827.692 655.356 864.184C668.99 891.122 733.885 826 759.5 826C785.115 826 829.701 907.584 861.512 871.667C888.686 840.987 897 720.898 897 677"
          stroke="black"
          stroke-width="50"
          stroke-linecap="round"
        />
      </g>

      <g class="surprised">
        <path
          id="palate"
          d="M542.492 355C470.342 398.267 530.859 443 602.51 443C693.815 443 734.679 361.6 739.787 361.6C744.895 361.6 782.566 443 878.979 443C963.669 443 1006.04 399.733 942.19 355"
          stroke="black"
          stroke-width="50"
          stroke-linecap="round"
        />
        <path
          id="jaw"
          d="M575.502 445.5C524.502 512.5 538.001 925 552.502 942.5C567.002 960 675.002 971.5 740.502 971.5C806.001 971.5 913.502 964.5 929.502 942.5C945.502 920.5 953.701 482.233 915.501 437.5"
          stroke="black"
          stroke-width="50"
          stroke-linecap="round"
        />
      </g>
      <g class="surprised">
        <path
          id="palate"
          d="M542.492 355C470.342 398.267 530.859 443 602.51 443C693.815 443 734.679 361.6 739.787 361.6C744.895 361.6 782.566 443 878.979 443C963.669 443 1006.04 399.733 942.19 355"
          stroke="black"
          stroke-width="50"
          stroke-linecap="round"
        />
        <path
          id="jaw"
          d="M575.503 445.5C524.503 512.5 561.003 836 575.503 853.5C590.004 871 698.004 882.5 763.503 882.5C829.002 882.5 936.503 875.5 952.503 853.5C968.503 831.5 953.702 482.233 915.502 437.5"
          stroke="black"
          stroke-width="50"
          stroke-linecap="round"
        />
      </g>

      <g class="derpy">
        <path
          id="palate"
          d="M553.5 399.5C476.675 442.767 525.211 544 601.505 544C698.726 544 725.061 499.5 730.5 499.5C735.939 499.5 793.227 544 895.887 544C986.064 544 1005.49 454.233 937.5 409.5"
          stroke="black"
          stroke-width="50"
          stroke-linecap="round"
        />
        <path
          id="jaw"
          d="M574 553C585.5 617.5 605.537 662 624.5 698C649.958 746.33 687.5 800.5 744.5 800.5C801.5 800.5 846.404 716 858.5 690.5C870.596 665 888.5 620.5 904 553"
          stroke="black"
          stroke-width="50"
          stroke-linecap="round"
        />
      </g>

      <g class="speechless">
        <path
          id="palate"
          d="M542 494C479.823 598.725 561.753 707 623.5 707C748.5 707 763.598 553 768 553C772.402 553 789.5 707 893.975 707C1011.5 707 1030.52 602.275 975.5 494"
          stroke="black"
          stroke-width="50"
          stroke-linecap="round"
        />
        <path
          id="jaw"
          d="M542 494C479.823 598.725 561.753 707 623.5 707C748.5 707 763.598 553 768 553C772.402 553 789.5 707 893.975 707C1011.5 707 1030.52 602.275 975.5 494"
          stroke="black"
          stroke-width="0"
          stroke-linecap="round"
        />
      </g>

      <g class="pleasant">
        <path
          id="palate"
          d="M437.686 525C346.06 613.5 466.796 705 557.788 705C741.992 705 764.241 574.859 770.728 574.859C777.214 574.859 802.411 705 956.369 705C1129.56 705 1157.59 616.5 1076.51 525"
          stroke="black"
          stroke-width="50"
          stroke-linecap="round"
        />
        <path
          id="jaw"
          d="M437.686 525C346.06 613.5 466.796 705 557.788 705C741.992 705 764.241 574.859 770.728 574.859C777.214 574.859 802.411 705 956.369 705C1129.56 705 1157.59 616.5 1076.51 525"
          stroke="black"
          stroke-width="0"
          stroke-linecap="round"
        />
      </g>

      <g id="confidence">
        <path id="palate" d="M560.999 675.001C517.834 718.267 551.632 752.5 594.499 752.5C711.5 752.5 745.419 669.601 748.475 669.601C751.531 669.601 761.5 752.5 888.999 761.001C939.554 764.371 1005.7 719.733 967.499 675" stroke="black" stroke-width="50" stroke-linecap="round" />
        <path id="jaw" d="M560.999 675.001C517.834 718.267 551.632 752.5 594.499 752.5C711.5 752.5 745.419 669.601 748.475 669.601C751.531 669.601 761.5 752.5 888.999 761.001C939.554 764.371 1005.7 719.733 967.499 675" stroke="black" stroke-width="50" stroke-linecap="round" />
      </g>
    </defs>
  </svg>
</template>

<script setup lang="ts">
import type { FacialExpression } from './type'
import { useMounted } from '@vueuse/core'
import anime from 'animejs'
import { onMounted, useId, watch } from 'vue'
import { getKeyframeList } from './utils'

// #region Props
interface Props {
  facialExpression: `${FacialExpression}`;
}
// #endregion Props
const props = withDefaults(defineProps<Props>(), {})

const id = useId()
const nameId = 'face-mouth'
const partIdList = ['palate', 'jaw'] as const

function getTargetId(partId: string) {
  return `#${id} #${nameId} #${partId}`
}

const facialExpressionProviderMap: Record<
  FacialExpression,
  () => Promise<void>
> = {
  neutral: async () => {
    const keyframeList = getKeyframeList(id, partIdList, 'neutral')

    await Promise.all(
      partIdList.map((partId) =>
        anime({
          targets: getTargetId(partId),
          ...keyframeList[0]?.[partId],
          duration: 500,
        }).finished,
      ),
    )
  },
  excited: async () => {
    const keyframeList = getKeyframeList(id, partIdList, 'excited')

    await Promise.all(
      partIdList.map((partId) =>
        anime({
          targets: getTargetId(partId),
          ...keyframeList[0]?.[partId],
          duration: 500,
        }).finished,
      ),
    )

    await Promise.all(
      partIdList.map((partId) =>
        anime({
          targets: getTargetId(partId),
          keyframes: keyframeList.map((keyframe) => keyframe[partId]),
          duration: 600,
          delay: 400,
          loop: true,
          easing: 'easeInOutCirc',
          direction: 'alternate',
        }).finished,
      ),
    )
  },
  happy: async () => {
    const keyframeList = getKeyframeList(id, partIdList, 'happy')

    await Promise.all(
      partIdList.map((partId) =>
        anime({
          targets: getTargetId(partId),
          ...keyframeList[0]?.[partId],
          duration: 500,
        }).finished,
      ),
    )

    await Promise.all(
      partIdList.map((partId) =>
        anime({
          targets: getTargetId(partId),
          keyframes: keyframeList.map((keyframe) => keyframe[partId]),
          duration: 600,
          delay: 400,
          loop: true,
          easing: 'easeInOutCirc',
          direction: 'alternate',
        }).finished,
      ),
    )
  },
  sad: async () => {
    const keyframeList = getKeyframeList(id, partIdList, 'sad')

    await Promise.all(
      partIdList.map((partId) =>
        anime({
          targets: getTargetId(partId),
          ...keyframeList[0]?.[partId],
          duration: 500,
        }).finished,
      ),
    )

    await Promise.all(
      partIdList.map((partId) =>
        anime({
          targets: getTargetId(partId),
          keyframes: keyframeList.map((keyframe) => keyframe[partId]),
          duration: 600,
          delay: 400,
          loop: true,
          easing: 'easeInOutCirc',
          direction: 'alternate',
        }).finished,
      ),
    )
  },
  angry: async () => {
    const keyframeList = getKeyframeList(id, partIdList, 'angry')

    await Promise.all(
      partIdList.map((partId) =>
        anime({
          targets: getTargetId(partId),
          ...keyframeList[0]?.[partId],
          duration: 500,
        }).finished,
      ),
    )
  },
  surprised: async () => {
    const keyframeList = getKeyframeList(id, partIdList, 'surprised')

    await Promise.all(
      partIdList.map((partId) =>
        anime({
          targets: getTargetId(partId),
          ...keyframeList[0]?.[partId],
          duration: 500,
        }).finished,
      ),
    )

    await Promise.all(
      partIdList.map((partId) =>
        anime({
          targets: getTargetId(partId),
          keyframes: keyframeList.map((keyframe) => keyframe[partId]),
          duration: 600,
          delay: 400,
          loop: true,
          easing: 'easeInOutCirc',
          direction: 'alternate',
        }).finished,
      ),
    )
  },
  derpy: async () => {
    const keyframeList = getKeyframeList(id, partIdList, 'derpy')

    await Promise.all(
      partIdList.map((partId) =>
        anime({
          targets: getTargetId(partId),
          ...keyframeList[0]?.[partId],
          duration: 500,
        }).finished,
      ),
    )
  },
  speechless: async () => {
    const keyframeList = getKeyframeList(id, partIdList, 'speechless')

    await Promise.all(
      partIdList.map((partId) =>
        anime({
          targets: getTargetId(partId),
          ...keyframeList[0]?.[partId],
          duration: 500,
        }).finished,
      ),
    )
  },
  pleasant: async () => {
    const keyframeList = getKeyframeList(id, partIdList, 'pleasant')

    await Promise.all(
      partIdList.map((partId) =>
        anime({
          targets: getTargetId(partId),
          ...keyframeList[0]?.[partId],
          duration: 500,
        }).finished,
      ),
    )
  },
  confidence: async () => {
    const keyframeList = getKeyframeList(id, partIdList, 'confidence')

    await Promise.all(
      partIdList.map((partId) =>
        anime({
          targets: getTargetId(partId),
          ...keyframeList[0]?.[partId],
          duration: 500,
        }).finished,
      ),
    )
  },
}
function startAnimation() {
  anime.remove(partIdList.map((id) => getTargetId(id)))
  facialExpressionProviderMap[props.facialExpression]?.()
}

onMounted(() => {
  startAnimation()
})

const isMounted = useMounted()
watch(() => props.facialExpression, () => {
  if (!isMounted.value)
    return

  startAnimation()
})
</script>

<style scoped lang="sass">
</style>
