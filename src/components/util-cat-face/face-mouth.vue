<template>
  <svg
    :id
    class="h-full w-full"
    viewBox="0 0 1500 1000"
    fill="none"
    xmlns="http://www.w3.org/2000/svg"
  >
    <g id="face-mouth">
      <path
        id="palate"
        d="M630.439 663C587.274 706.267 623.48 751 666.346 751C720.972 751 745.419 669.6 748.475 669.6C751.531 669.6 774.069 751 831.75 751C882.417 751 907.767 707.733 869.568 663"
        stroke="black"
        stroke-width="50"
        stroke-linecap="round"
      />
      <path
        id="jaw"
        d="M630.439 663C587.274 706.267 623.48 751 666.346 751C720.972 751 745.419 669.6 748.475 669.6C751.531 669.6 774.069 751 831.75 751C882.417 751 907.767 707.733 869.568 663"
        stroke="black"
        stroke-width="50"
        stroke-linecap="round"
      />
    </g>

    <defs class="hidden">
      <!-- neutral -->
      <g class="neutral">
        <path
          id="palate"
          d="M630.439 663C587.274 706.267 623.48 751 666.346 751C720.972 751 745.419 669.6 748.475 669.6C751.531 669.6 774.069 751 831.75 751C882.417 751 907.767 707.733 869.568 663"
          stroke="black"
          stroke-width="50"
          stroke-linecap="round"
        />
        <path
          id="jaw"
          d="M630.439 663C587.274 706.267 623.48 751 666.346 751C720.972 751 745.419 669.6 748.475 669.6C751.531 669.6 774.069 751 831.75 751C882.417 751 907.767 707.733 869.568 663"
          stroke="black"
          stroke-width="50"
          stroke-linecap="round"
        />
      </g>

      <!-- excited -->
      <g class="excited">
        <path
          id="palate"
          d="M621.439 523C578.274 566.267 614.48 611 657.346 611C711.972 611 736.419 529.6 739.475 529.6C742.531 529.6 765.069 611 822.75 611C873.417 611 898.767 567.733 860.568 523"
          stroke="black"
          stroke-width="50"
          stroke-linecap="round"
        />
        <path
          id="jaw"
          d="M625.5 607C569.5 674 633 888 671.5 924C695.563 946.5 730.5 968.5 783.5 968.5C836.5 968.5 866.501 952.5 895 924C928.034 890.966 906.001 653 859.001 607"
          stroke="black"
          stroke-width="50"
          stroke-linecap="round"
        />
      </g>

      <!-- happy -->
      <g class="happy">
        <path
          id="palate"
          d="M582.369 591C521.595 634.267 572.57 679 632.925 679C709.834 679 744.255 597.6 748.557 597.6C752.859 597.6 784.592 679 865.803 679C937.14 679 972.831 635.733 919.048 591"
          stroke="black"
          stroke-width="50"
          stroke-linecap="round"
        />
        <path
          id="jaw"
          d="M569.887 679C547.501 709.5 513.947 858.15 573.772 903.251C611.164 931.438 665.453 959 747.809 959C830.165 959 876.783 938.955 921.069 903.251C972.401 861.865 949.001 726 932.723 679"
          stroke="black"
          stroke-width="50"
          stroke-linecap="round"
        />
      </g>
      <g class="happy">
        <path
          id="palate"
          d="M574.774 578C514 621.267 564.976 666 625.33 666C702.239 666 736.66 584.6 740.962 584.6C745.265 584.6 776.997 666 858.209 666C929.545 666 965.236 622.733 911.453 578"
          stroke="black"
          stroke-width="50"
          stroke-linecap="round"
        />
        <path
          id="jaw"
          d="M562.291 666C539.905 696.5 502.467 804.399 562.292 849.5C599.683 877.688 653.972 905.249 736.329 905.249C818.685 905.249 865.303 885.205 909.589 849.5C960.921 808.115 941.405 713 925.127 666"
          stroke="black"
          stroke-width="50"
          stroke-linecap="round"
        />
      </g>

      <!-- sad -->
      <g class="sad">
        <path
          id="jaw"
          d="M529 735C583.5 701 623.479 751 666.346 751C720.971 751 745.419 669.6 748.475 669.6C751.531 669.6 774.069 751 831.75 751C882.417 751 903.5 698.5 970 759"
          stroke="black"
          stroke-width="50"
          stroke-linecap="round"
        />
        <path
          id="palate"
          d="M529 735C583.5 701 623.479 751 666.346 751C720.971 751 745.419 669.6 748.475 669.6C751.531 669.6 774.069 751 831.75 751C882.417 751 903.5 698.5 970 759"
          stroke="black"
          stroke-width="50"
          stroke-linecap="round"
        />
      </g>

      <!-- angry -->
      <g class="angry">
        <path
          id="palate"
          d="M560.999 675.001C517.834 718.267 551.632 752.5 594.499 752.5C711.5 752.5 745.419 669.601 748.475 669.601C751.531 669.601 761.5 752.5 888.999 761.001C939.554 764.371 1005.7 719.733 967.499 675"
          stroke="black"
          stroke-width="50"
          stroke-linecap="round"
        />
        <path
          id="jaw"
          d="M560.999 675.001C517.834 718.267 551.632 752.5 594.499 752.5C711.5 752.5 745.419 669.601 748.475 669.601C751.531 669.601 761.5 752.5 888.999 761.001C939.554 764.371 1005.7 719.733 967.499 675"
          stroke="black"
          stroke-width="50"
          stroke-linecap="round"
        />
      </g>

      <!-- surprised -->
      <g class="surprised">
        <path
          id="palate"
          d="M550.492 529C478.342 572.267 538.859 617 610.51 617C701.815 617 742.679 535.6 747.787 535.6C752.895 535.6 790.566 617 886.979 617C971.669 617 1014.04 573.733 950.19 529"
          stroke="black"
          stroke-width="50"
          stroke-linecap="round"
        />
        <path
          id="jaw"
          d="M577.001 627C526 694 538 925 552.501 942.5C567.001 960 675.001 971.5 740.5 971.5C806 971.5 913.5 964.5 929.5 942.5C945.5 920.5 955.199 663.733 917 619"
          stroke="black"
          stroke-width="50"
          stroke-linecap="round"
        />
      </g>
      <g class="surprised">
        <path
          id="palate"
          d="M550.492 529C478.342 572.267 538.859 617 610.51 617C701.815 617 742.679 535.6 747.787 535.6C752.895 535.6 790.566 617 886.979 617C971.669 617 1014.04 573.733 950.19 529"
          stroke="black"
          stroke-width="50"
          stroke-linecap="round"
        />
        <path
          id="jaw"
          d="M577.002 627C526.002 694 545.5 838.5 560 856C574.501 873.5 682.501 885 748 885C813.499 885 921 878 937 856C953 834 955.201 663.733 917.002 619"
          stroke="black"
          stroke-width="50"
          stroke-linecap="round"
        />
      </g>
    </defs>
  </svg>
</template>

<script setup lang="ts">
import type { FacialExpression } from './type'
import { useMounted } from '@vueuse/core'
import anime from 'animejs'
import { onMounted, useId, watch } from 'vue'
import { getKeyframeList } from './utils'

// #region Props
interface Props {
  facialExpression: `${FacialExpression}`;
}
// #endregion Props
const props = withDefaults(defineProps<Props>(), {})

const id = useId()
const nameId = 'face-mouth'
const partIdList = ['palate', 'jaw'] as const

function getTargetId(partId: string) {
  return `#${id} #${nameId} #${partId}`
}

const facialExpressionProviderMap: Record<
  FacialExpression,
  () => Promise<void>
> = {
  neutral: async () => {
    const keyframeList = getKeyframeList(id, partIdList, 'neutral')

    await Promise.all(
      partIdList.map((partId) =>
        anime({
          targets: getTargetId(partId),
          ...keyframeList[0]?.[partId],
          duration: 500,
        }).finished,
      ),
    )
  },
  excited: async () => {
    const keyframeList = getKeyframeList(id, partIdList, 'excited')

    await Promise.all(
      partIdList.map((partId) =>
        anime({
          targets: getTargetId(partId),
          ...keyframeList[0]?.[partId],
          duration: 500,
        }).finished,
      ),
    )

    await Promise.all(
      partIdList.map((partId) =>
        anime({
          targets: getTargetId(partId),
          keyframes: keyframeList.map((keyframe) => keyframe[partId]),
          duration: 600,
          delay: 400,
          loop: true,
          easing: 'easeInOutCirc',
          direction: 'alternate',
        }).finished,
      ),
    )
  },
  happy: async () => {
    const keyframeList = getKeyframeList(id, partIdList, 'happy')

    await Promise.all(
      partIdList.map((partId) =>
        anime({
          targets: getTargetId(partId),
          ...keyframeList[0]?.[partId],
          duration: 500,
        }).finished,
      ),
    )

    await Promise.all(
      partIdList.map((partId) =>
        anime({
          targets: getTargetId(partId),
          keyframes: keyframeList.map((keyframe) => keyframe[partId]),
          duration: 600,
          delay: 400,
          loop: true,
          easing: 'easeInOutCirc',
          direction: 'alternate',
        }).finished,
      ),
    )
  },
  sad: async () => {
    const keyframeList = getKeyframeList(id, partIdList, 'sad')

    await Promise.all(
      partIdList.map((partId) =>
        anime({
          targets: getTargetId(partId),
          ...keyframeList[0]?.[partId],
          duration: 500,
        }).finished,
      ),
    )

    await Promise.all(
      partIdList.map((partId) =>
        anime({
          targets: getTargetId(partId),
          keyframes: keyframeList.map((keyframe) => keyframe[partId]),
          duration: 600,
          delay: 400,
          loop: true,
          easing: 'easeInOutCirc',
          direction: 'alternate',
        }).finished,
      ),
    )
  },
  angry: async () => {
    const keyframeList = getKeyframeList(id, partIdList, 'angry')

    await Promise.all(
      partIdList.map((partId) =>
        anime({
          targets: getTargetId(partId),
          ...keyframeList[0]?.[partId],
          duration: 500,
        }).finished,
      ),
    )
  },
  surprised: async () => {
    const keyframeList = getKeyframeList(id, partIdList, 'surprised')

    await Promise.all(
      partIdList.map((partId) =>
        anime({
          targets: getTargetId(partId),
          ...keyframeList[0]?.[partId],
          duration: 500,
        }).finished,
      ),
    )

    await Promise.all(
      partIdList.map((partId) =>
        anime({
          targets: getTargetId(partId),
          keyframes: keyframeList.map((keyframe) => keyframe[partId]),
          duration: 600,
          delay: 400,
          loop: true,
          easing: 'easeInOutCirc',
          direction: 'alternate',
        }).finished,
      ),
    )
  },
}
function startAnimation() {
  anime.remove(partIdList.map((id) => `#${nameId} #${id}`))
  facialExpressionProviderMap[props.facialExpression]?.()
}

onMounted(() => {
  startAnimation()
})

const isMounted = useMounted()
watch(() => props.facialExpression, () => {
  if (!isMounted.value)
    return

  startAnimation()
})
</script>

<style scoped lang="sass">
</style>
